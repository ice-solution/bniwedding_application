# BNI BNWG Application - Apache2 VirtualHost Configuration
# For Cloudflare Flexible SSL (HTTPS -> HTTP)

<VirtualHost *:80>
    ServerName bniwedding.brandcativation.hk
    ServerAlias www.bniwedding.brandcativation.hk
    
    # 記錄真實的客戶端 IP（來自 Cloudflare）
    LogFormat "%{X-Forwarded-For}i %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" cloudflare
    CustomLog ${APACHE_LOG_DIR}/bniwedding-access.log cloudflare
    ErrorLog ${APACHE_LOG_DIR}/bniwedding-error.log

    # 設定文檔根目錄（前端靜態文件）
    DocumentRoot /var/www/bniwedding_application/frontend/dist
    
    <Directory /var/www/bniwedding_application/frontend/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # 處理前端路由（SPA）
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # 靜態資源（直接服務）
    <Directory /var/www/bniwedding_application/frontend/dist>
        <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|svg)$">
            ExpiresActive On
            ExpiresDefault "access plus 1 year"
            Header set Cache-Control "public, immutable"
        </FilesMatch>
    </Directory>

    # API 請求代理到後端 Node.js 服務器
    ProxyPreserveHost On
    ProxyRequests Off

    # API 路由
    <Location /api>
        ProxyPass http://127.0.0.1:6137/api
        ProxyPassReverse http://127.0.0.1:6137/api

        # 設置代理頭部
        RequestHeader set X-Forwarded-Proto "http"
        RequestHeader set X-Forwarded-Host "bniwedding.brandcativation.hk"
        RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"
        RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"
    </Location>

    # 後端靜態文件（banner 圖片等）
    <Location /static>
        ProxyPass http://127.0.0.1:6137/static
        ProxyPassReverse http://127.0.0.1:6137/static

        # 設置代理頭部
        RequestHeader set X-Forwarded-Proto "http"
        RequestHeader set X-Forwarded-Host "bniwedding.brandcativation.hk"
    </Location>

    # 健康檢查
    <Location /health>
        ProxyPass http://127.0.0.1:6137/health
        ProxyPassReverse http://127.0.0.1:6137/health
    </Location>

    # 安全標頭
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Cloudflare 真實 IP 設定
    # 安裝 mod_cloudflare 或使用 mod_remoteip
    # 如果使用 mod_remoteip，取消以下註解：
    # RemoteIPHeader CF-Connecting-IP
    # RemoteIPTrustedProxy 173.245.48.0/20
    # RemoteIPTrustedProxy 103.21.244.0/22
    # RemoteIPTrustedProxy 103.22.200.0/22
    # RemoteIPTrustedProxy 103.31.4.0/22
    # RemoteIPTrustedProxy 141.101.64.0/18
    # RemoteIPTrustedProxy 108.162.192.0/18
    # RemoteIPTrustedProxy 190.93.240.0/20
    # RemoteIPTrustedProxy 188.114.96.0/20
    # RemoteIPTrustedProxy 197.234.240.0/22
    # RemoteIPTrustedProxy 198.41.128.0/17
    # RemoteIPTrustedProxy 162.158.0.0/15
    # RemoteIPTrustedProxy 104.16.0.0/13
    # RemoteIPTrustedProxy 104.24.0.0/14
    # RemoteIPTrustedProxy 172.64.0.0/13
    # RemoteIPTrustedProxy 131.0.72.0/22
    # RemoteIPTrustedProxy 2400:cb00::/32
    # RemoteIPTrustedProxy 2606:4700::/32
    # RemoteIPTrustedProxy 2803:f800::/32
    # RemoteIPTrustedProxy 2405:b500::/32
    # RemoteIPTrustedProxy 2405:8100::/32
    # RemoteIPTrustedProxy 2a06:98c0::/29
    # RemoteIPTrustedProxy 2c0f:f248::/32
</VirtualHost>

# 如果需要強制 HTTPS（在 Cloudflare 層面處理，這裡只是備用）
# <VirtualHost *:443>
#     ServerName bniwedding.brandcativation.hk
#     ServerAlias www.bniwedding.brandcativation.hk
#     
#     SSLEngine on
#     SSLCertificateFile /path/to/your/certificate.crt
#     SSLCertificateKeyFile /path/to/your/private.key
#     
#     # 其他配置與上面相同...
# </VirtualHost>
